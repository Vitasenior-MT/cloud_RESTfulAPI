require("source-map-support").install(),function(e){var t={};function r(o){if(t[o])return t[o].exports;var s=t[o]={i:o,l:!1,exports:{}};return e[o].call(s.exports,s,s.exports,r),s.l=!0,s.exports}r.m=e,r.c=t,r.d=function(e,t,o){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},r.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r.w={},r(r.s=39)}([function(e,t,r){var o=r(3),s=r(36);const n={$eq:s.Op.eq,$ne:s.Op.ne,$gte:s.Op.gte,$gt:s.Op.gt,$lte:s.Op.lte,$lt:s.Op.lt,$not:s.Op.not,$in:s.Op.in,$notIn:s.Op.notIn,$is:s.Op.is,$like:s.Op.like,$notLike:s.Op.notLike,$iLike:s.Op.iLike,$notILike:s.Op.notILike,$regexp:s.Op.regexp,$notRegexp:s.Op.notRegexp,$iRegexp:s.Op.iRegexp,$notIRegexp:s.Op.notIRegexp,$between:s.Op.between,$notBetween:s.Op.notBetween,$overlap:s.Op.overlap,$contains:s.Op.contains,$contained:s.Op.contained,$adjacent:s.Op.adjacent,$strictLeft:s.Op.strictLeft,$strictRight:s.Op.strictRight,$noExtendRight:s.Op.noExtendRight,$noExtendLeft:s.Op.noExtendLeft,$and:s.Op.and,$or:s.Op.or,$any:s.Op.any,$all:s.Op.all,$values:s.Op.values,$col:s.Op.col};o.connect("mongodb://localhost:27017/myproject");var a=new s("mysql://api:123qwe@localhost:3306/node",{operatorsAliases:n,logging:!1});const i={Boardmodel:r(35)(a,s),Board:r(34)(a,s),Patient:r(33)(a,s),Sensor:r(32)(a,s),UserVitabox:r(31)(a,s),User:r(30)(a,s),Vitabox:r(29)(a,s),record:r(28)};Object.keys(i).forEach(e=>{i[e].associate&&i[e].associate(i)}),i.sequelize=a,i.mongoose=o.connection,e.exports=i},function(e,t,r){e.exports.v1_0_0={boardmodel:r(18),board:r(17),patient:r(16),record:r(15),sensor:r(14),user:r(13),utils:r(2),vitabox:r(12)}},function(e,t,r){(function(e){var o=r(26),s=r(25),n=r(24),a=r(0);t.encrypt=function(e){return new Promise((t,r)=>{e.forEach((t,r)=>{let s=o.createCipher(process.env.ALGORITHM,process.env.KEY);return e[r]=s.update(Buffer.from(t),"utf8","hex")+s.final("hex")}),t(e)})},t.decrypt=function(e){let t=o.createDecipher(process.env.ALGORITHM,process.env.KEY);return t.update(e,"hex","utf8")+t.final("utf8")},t.createToken=function(t,r){return new Promise((o,a)=>{let i=s.readFileSync(e+"/../../keys/key.pem").toString();void 0===i&&a(new Error("error on load private key"));let d={id:t.id,role:t.constructor.name},u={expiresIn:"8h",algorithm:"RS256",subject:r};n.sign(d,i,u,function(e,t){e&&a(e),o(t)})})},t.validateToken=function(t,r){return new Promise((o,i)=>{let d=s.readFileSync(e+"/../../keys/cert.pem").toString();void 0===d&&i("error on load public key");let u={algorithms:["RS256"],subject:r};n.verify(t,d,u,function(e,t){e&&i(e),a[t.role].findById(t.id).then(e=>o(e),e=>i(e.message))})})},t.generatePassword=(()=>{let e,t="";for(e=0;e<10;e++)t+="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"[Math.floor(61*Math.random())];return t}),t.deleteAll=function(){return new Promise((e,t)=>{var r={raw:!0};a.sequelize.query("SET FOREIGN_KEY_CHECKS = 0",r).then(()=>{a.UserVitabox.truncate().then(()=>{a.User.truncate().then(()=>{a.Vitabox.truncate().then(()=>{a.Boardmodel.truncate().then(()=>{a.Board.truncate().then(()=>{a.Patient.truncate().then(()=>{a.Record.remove({},()=>{a.sequelize.query("SET FOREIGN_KEY_CHECKS = 1",r).then(()=>e(),e=>t(e))})},e=>t(e))},e=>t(e))},e=>t(e))},e=>t(e))},e=>t(e))},e=>t(e))},e=>t(e))})}}).call(this,"app/business/v1.0.0")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express-routes-versioning")},function(e,t,r){var o=r(1).v1_0_0;t.create=function(e,t){"User"===e.client.constructor.name&&e.client.admin?o.vitabox.create().then(e=>t.status(201).json(e),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})},t.register=function(e,t){"User"===e.client.constructor.name&&e.client.admin?o.user.findByEmail(e.body.email).then(r=>{o.vitabox.register(e.params.id,e.body).then(s=>{o.vitabox.addUser(e.client,s.id,r.id,!0).then(()=>t.status(201).json({result:!0}),e=>t.status(500).json({error:e.message}))},e=>t.status(500).json({error:e.message}))},e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})},t.connect=function(e,t){o.vitabox.connect(e.params.id,e.body.password).then(r=>{o.utils.createToken(r,e.connection.remoteAddress).then(e=>t.status(201).json({token:e}),e=>t.status(500).json({error:e.message}))},e=>t.status(500).json({error:e.message}))},t.list=function(e,t){"User"===e.client.constructor.name?o.vitabox.list(e.client).then(e=>t.status(200).json({vitaboxes:e}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})},t.find=function(e,t){"User"===e.client.constructor.name?o.vitabox.find(e.client,e.params.id).then(e=>t.status(200).json({vitabox:e}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})},t.update=function(e,t){"User"===e.client.constructor.name?o.vitabox.update(e.client,e.params.id,e.body).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})},t.delete=function(e,t){"User"===e.client.constructor.name?o.vitabox.delete(e.client,e.params.id).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})},t.addUser=function(e,t){"User"===e.client.constructor.name?o.vitabox.addUser(e.client,e.params.id,e.body.user_id).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})},t.getUsers=function(e,t){o.vitabox.getUsers("User"===e.client.constructor.name,e.client,e.params.id).then(e=>t.status(200).json({users:e}),e=>t.status(500).json({error:e.message}))},t.removeUser=function(e,t){"User"===e.client.constructor.name?o.vitabox.removeUser(e.client,e.params.id,e.body.user_id).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})},t.addPatient=function(e,t){"User"===e.client.constructor.name?o.patient.create(e.body).then(r=>o.vitabox.addPatient(e.client,e.params.id,r.id).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})},t.getPatients=function(e,t){o.vitabox.getPatients("User"===e.client.constructor.name,e.client,e.params.id).then(e=>t.status(200).json({patients:e}),e=>t.status(500).json({error:e.message}))},t.removePatient=function(e,t){"User"===e.client.constructor.name?o.vitabox.removePatient(e.client,e.params.id,e.body.patient_id).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})},t.addBoard=function(e,t){"User"===e.client.constructor.name?o.board.create(e.body).then(r=>o.vitabox.addBoard(e.client,e.params.id,r.id).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})},t.getBoards=function(e,t){o.vitabox.getBoards("User"===e.client.constructor.name,e.client,e.params.id).then(e=>t.status(200).json({boards:e}),e=>t.status(500).json({error:e.message}))},t.removeBoard=function(e,t){"User"===e.client.constructor.name?o.vitabox.removeBoard(e.client,e.params.id,e.body.board_id).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})}},function(e,t,r){var o=r(1).v1_0_0;t.register=function(e,t){o.user.register(e.body.email,e.body.password).then(r=>{o.utils.createToken(r,e.connection.remoteAddress).then(e=>t.status(201).json({token:e,user:r.id}),e=>t.status(500).json({error:e.message}))},e=>t.status(500).json({error:e.message}))},t.login=function(e,t){o.user.login(e.body.email,e.body.password).then(r=>{o.utils.createToken(r,e.connection.remoteAddress).then(e=>t.status(201).json({token:e,user:r.id}),e=>t.status(500).json({error:e.message}))},e=>t.status(500).json({error:e.message}))},t.changePassword=function(e,t){"User"===e.client.constructor.name?o.user.changePassword(e.client.id,e.body.old_password,e.body.new_password).then(()=>t.status(201).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})}},function(e,t,r){var o=r(1).v1_0_0;t.create=((e,t)=>{"User"===e.client.constructor.name&&e.client.admin?o.sensor.create(e.body).then(e=>t.status(200).json({id:e.id}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})}),t.list=((e,t)=>{"User"===e.client.constructor.name&&e.client.admin?o.sensor.list().then(e=>t.status(200).json({sensors:e}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})}),t.update=((e,t)=>{"User"===e.client.constructor.name&&e.client.admin?o.sensor.update(e.params.id,e.body).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})}),t.delete=((e,t)=>{"User"===e.client.constructor.name&&e.client.admin?o.sensor.remove(e.params.id).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})})},function(e,t,r){var o=r(1).v1_0_0;t.create=function(e,t){o.record.create(e.body).then(e=>t.status(201).json({result:!0}),e=>t.status(500).json({result:!1,error:e.message}))},t.list=function(e,t){o.record.list().then(e=>t.status(201).json({records:e}),e=>t.status(500).json({error:e.message}))}},function(e,t,r){var o=r(1).v1_0_0;t.destroyAll=function(e,t){o.utils.deleteAll().then(()=>t.status(201).json({success:!0}),e=>t.status(500).json({msg:e.message}))}},function(e,t,r){r(1).v1_0_0},function(e,t,r){var o=r(0),s=r(2);t.create=function(){return new Promise((e,t)=>{let r=s.generatePassword();s.encrypt([r]).then(s=>{o.Vitabox.create({password:s[0]}).then(t=>e({id:t.id,password:r}),e=>t(e))},e=>t(e))})},t.register=function(e,t){return new Promise((r,s)=>{o.Vitabox.findOne({where:{id:e,registered:!1}}).then(e=>{e?e.update({registered:!0,address:t.address,longitude:t.longitude,latitude:t.latitude}).then(()=>r(e),e=>s(e)):s(new Error("Vitabox already registered or doesn´t exist"))},e=>s(e))})},t.connect=function(e,t){return new Promise((r,n)=>{s.encrypt([t]).then(t=>{o.Vitabox.findOne({where:{password:t[0],id:e}}).then(e=>{e?e.update({active:!0}).then(()=>r(e),e=>n(e)):n(new Error("vitabox id or password incorrect, verify if was already registered"))},e=>n(e))},e=>n(e))})},t.list=function(e){return new Promise((t,r)=>{e.admin?o.Vitabox.findAll({attributes:{exclude:["password"]}}).then(e=>t(e),e=>r(e)):e.getVitaboxes({attributes:["id","latitude","longitude","address"],where:{active:!0}}).then(e=>{e.forEach(e=>{e.dataValues.sponsor=e.dataValues.UserVitabox.dataValues.sponsor,delete e.dataValues.UserVitabox}),t(e)},e=>r(e))})},t.find=function(e,t){return new Promise((r,s)=>{e.admin?o.Vitabox.findById(t,{attributes:{exclude:["password"]}}).then(e=>{e?r(e):s(new Error("Vitabox not found"))},e=>s(e)):e.getVitaboxes({attributes:["id","latitude","longitude","address"],where:{id:t,active:!0}}).then(e=>{e.length>0?(e[0].dataValues.sponsor=e[0].dataValues.UserVitabox.dataValues.sponsor,delete e[0].dataValues.UserVitabox,r(e[0])):s(new Error("Vitabox not found"))},e=>s(e))})},t.update=function(e,t,r){return new Promise((s,n)=>{o.Vitabox.findById(t).then(t=>{t?e.admin?t.update({latitude:r.latitude,longitude:r.longitude,address:r.address,settings:r.settings}).then(()=>s(),e=>n(e)):_isSponsor(t,e).then(()=>{t.update({latitude:r.latitude,longitude:r.longitude,address:r.address}).then(()=>s(),e=>n(e))},e=>n(e)):n(new Error("Vitabox not found"))},e=>n(e))})},t.delete=function(e,t){return new Promise((r,s)=>{o.Vitabox.findById(t).then(t=>{t?e.admin?t.destroy().then(()=>r(),e=>s(e.message)):_isSponsor(t,e).then(()=>{t.destroy().then(()=>r(),e=>s(e.message))},e=>s(e)):s(new Error("Vitabox not found"))},e=>s(e))})},t.addUser=function(e,t,r,s){return new Promise((n,a)=>{o.Vitabox.findById(t).then(t=>{t?e.admin?t.addUser(r,{through:{sponsor:s}}).then(()=>n(),e=>a(e)):_isSponsor(t,e).then(()=>{t.addUser(r,{through:{sponsor:s}}).then(()=>n(),e=>a(e))},e=>a(e)):a(new Error("Vitabox not found"))},e=>a(e))})},t.getUsers=function(e,t,r){return new Promise((n,a)=>{e?o.Vitabox.findById(r).then(e=>{e?t.admin?e.getUsers({attributes:["id","email"]}).then(e=>{e.forEach(e=>{e.email=s.decrypt(e.email),e.dataValues.since=e.dataValues.UserVitabox.dataValues.created_at,e.dataValues.sponsor=e.dataValues.UserVitabox.dataValues.sponsor,delete e.dataValues.UserVitabox}),n(e)},e=>a(e)):_isUser(e,t).then(()=>{e.getUsers({attributes:["id","email"]}).then(e=>{e.forEach(e=>{e.email=s.decrypt(e.email),e.dataValues.since=e.dataValues.UserVitabox.dataValues.created_at,e.dataValues.sponsor=e.dataValues.UserVitabox.dataValues.sponsor,delete e.dataValues.UserVitabox}),n(e)},e=>a(e))},e=>a(e)):a(new Error("Vitabox not found"))},e=>a(e)):t.getUsers({attributes:["id","email"]}).then(e=>{e.forEach(e=>{e.email=s.decrypt(e.email),e.dataValues.since=e.dataValues.UserVitabox.dataValues.createdAt,e.dataValues.sponsor=e.dataValues.UserVitabox.dataValues.sponsor,delete e.dataValues.UserVitabox}),n(e)},e=>a(e))})},t.removeUser=function(e,t,r){return new Promise((s,n)=>{o.Vitabox.findById(t).then(t=>{t?e.admin?t.removeUser(r).then(()=>s(),e=>n(e)):_isSponsor(t,e).then(()=>{t.removeUser(r).then(()=>s(),e=>n(e))},e=>n(e)):n(new Error("Vitabox not found"))},e=>n(e))})},t.addPatient=function(e,t,r){return new Promise((s,n)=>{o.Vitabox.findById(t).then(t=>{t?e.admin?t.addPatient(r).then(()=>s(),e=>n(e)):_isSponsor(t,e).then(()=>{t.addPatient(r).then(()=>s(),e=>n(e))},e=>n(e)):n(new Error("Vitabox not found"))},e=>n(e))})},t.getPatients=function(e,t,r){return new Promise((n,a)=>{e?t.admin?o.Patient.findAll({where:{vitabox_id:r},attributes:["id","birthdate","name","gender",["created_at","since"]]}).then(e=>{e.forEach(e=>e.name=s.decrypt(e.name)),n(e)},e=>a(e)):_isUser(vitabox,t).then(()=>{o.Patient.findAll({where:{vitabox_id:r},attributes:["id","birthdate","name","gender",["created_at","since"]]}).then(e=>{e.forEach(e=>e.name=s.decrypt(e.name)),n(e)},e=>a(e))},e=>a(e)):t.getPatients({attributes:["id","birthdate","name","gender",["createdAt","since"]]}).then(e=>{e.forEach(e=>{e.name=s.decrypt(e.name),delete e.dataValues.VitaboxId}),n(e)},e=>a(e))})},t.removePatient=function(e,t,r){return new Promise((s,n)=>{o.Vitabox.findById(t).then(t=>{t?e.admin?t.removePatient(r).then(()=>s(),e=>n(e)):_isSponsor(t,e).then(()=>{t.removePatient(r).then(()=>s(),e=>n(e))},e=>n(e)):n(new Error("Vitabox not found"))},e=>n(e))})},t.addBoard=function(e,t,r){return new Promise((s,n)=>{o.Vitabox.findById(t).then(t=>{t?e.admin?t.addBoard(r).then(()=>s(),e=>n(e)):_isSponsor(t,e).then(()=>{t.addBoard(r).then(()=>s(),e=>n(e))},e=>n(e)):n(new Error("Vitabox not found"))},e=>n(e))})},t.getBoards=function(e,t,r){return new Promise((s,n)=>{e?t.admin?o.Board.findAll({where:{vitabox_id:r},include:[{model:o.Boardmodel,attributes:["id","type","name"],include:[{model:o.Sensor,attributes:{exclude:["created_at","updated_at"]}}]}],attributes:["id","location","created_at"]}).then(e=>{e.forEach(e=>e.Boardmodel.Sensors.forEach(e=>delete e.dataValues.BoardSensor)),s(e)},e=>n(e)):_isUser(vitabox,t).then(()=>{o.Board.findAll({where:{vitabox_id:r},include:[{model:o.Boardmodel,attributes:["id","type","name"],include:[{model:o.Sensor,attributes:{exclude:["created_at","updated_at"]}}]}],attributes:["id","location","created_at"]}).then(e=>{e.forEach(e=>e.Boardmodel.Sensors.forEach(e=>delete e.dataValues.BoardSensor)),s(e)},e=>n(e))},e=>n(e)):t.getBoards({attributes:["id","location","created_at"],include:[{model:o.Boardmodel,attributes:["id","type","name"],include:[{model:o.Sensor,attributes:{exclude:["created_at","updated_at"]}}]}]}).then(e=>{e.forEach(e=>e.Boardmodel.Sensors.forEach(e=>delete e.dataValues.BoardSensor)),s(e)},e=>n(e))})},t.removeBoard=function(e,t,r){return new Promise((s,n)=>{o.Vitabox.findById(t).then(t=>{t?e.admin?t.removeBoard(r).then(()=>s(),e=>n(e)):_isSponsor(t,e).then(()=>{t.removeBoard(r).then(()=>s(),e=>n(e))},e=>n(e)):n(new Error("Vitabox not found"))},e=>n(e))})},_isSponsor=((e,t)=>new Promise((r,o)=>{e.getUsers({through:{sponsor:!0},where:{id:t.id}}).then(e=>{e.length>0?r():o(new Error("Unauthorized"))},e=>o(e))})),_isUser=((e,t)=>new Promise((r,o)=>{e.hasUser(t).then(e=>{e?r():o(new Error("Unauthorized"))},e=>o(e))}))},function(e,t,r){var o=r(0),s=r(2);t.register=function(e,t){return new Promise((r,n)=>{/^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)[A-Za-z\d$@$!%*#?&-.]{8,}$/.test(t)?/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/.test(e)?s.encrypt([e,t]).then(e=>{o.User.create({email:e[0],password:e[1]}).then(e=>r(e),e=>n(e))},e=>n(e)):n(new Error("invalid email")):n(new Error("invalid password, must have at least one uppercase letter, one lowercase, one digit and a minimum 8 characters"))})},t.login=function(e,t){return new Promise((r,n)=>{s.encrypt([e,t]).then(e=>{o.User.findOne({where:{email:e[0],password:e[1]}}).then(e=>{e?r(e):n(new Error("email and password don't match"))},e=>n(e))},e=>n(e))})},t.changePassword=function(e,t,r){return new Promise((n,a)=>{s.encrypt([t,r]).then(t=>{o.User.findOne({where:{id:e,password:t[0]}}).then(e=>{e?e.update({password:t[1]}).then(()=>n(),e=>a(e)):a(new Error("old password don't match"))},e=>a(e))},e=>a(e))})},t.findByEmail=function(e,t){return new Promise((t,r)=>{s.encrypt([e]).then(e=>{o.User.findOne({where:{email:e[0]}}).then(e=>{e?t(e):r(new Error("user not registered"))},e=>r(e))},e=>r(e))})}},function(e,t,r){var o=r(0);t.create=(e=>new Promise((t,r)=>{o.Sensor.create({transducer:e.transducer,measure:e.measure,min_acceptable:e.min_acceptable,max_acceptable:e.max_acceptable,min_possible:e.min_possible,max_possible:e.max_possible}).then(e=>t(e),e=>r(e))})),t.list=(e=>new Promise((e,t)=>{o.Sensor.findAll({attributes:{exclude:["created_at","updated_at"]}}).then(t=>e(t),e=>t(e))})),t.update=((e,t)=>new Promise((r,s)=>{o.Sensor.findById(e).then(e=>{e?e.update({transducer:t.transducer,measure:t.measure,min_acceptable:t.min_acceptable,max_acceptable:t.max_acceptable,min_possible:t.min_possible,max_possible:t.max_possible}).then(()=>r(),e=>s(e)):s(new Error("sensor not found"))},e=>s(e))})),t.remove=(e=>new Promise((t,r)=>{o.Sensor.findById(e).then(e=>{e?e.destroy().then(()=>t(),e=>r(e)):r(new Error("sensor not found"))},e=>r(e))}))},function(e,t,r){var o=r(0);t.create=function(e){return new Promise((t,r)=>{new o.Record({value:e.value,datetime:e.datetime,patient_id:e.patient_id,board_id:e.board_id,sensor_id:e.sensor_id}).save((e,o)=>{e?r(e):t(o)})})},t.list=function(){return new Promise((e,t)=>{o.Record.find((r,o)=>{r?t(r):e(o)})})}},function(e,t,r){var o=r(0),s=r(2);t.create=(e=>new Promise((t,r)=>{s.encrypt([e.name]).then(s=>o.Patient.create({name:s[0],birthdate:e.birthdate,gender:e.gender}).then(e=>t(e),e=>r(e)),e=>r(e))}))},function(e,t,r){var o=r(0);t.create=(e=>new Promise((t,r)=>{o.Board.create({location:e.location,boardmodel_id:e.model}).then(e=>t(e),e=>r(e))})),t.find=(e=>new Promise((t,r)=>{o.Board.findById(e).then(e=>{e.getBoardmodel().then(e=>t(e),e=>r(e))},e=>r(e))})),t.remove=(e=>new Promise((t,r)=>{o.Board.findById(e).then(e=>e.destroy().then(()=>t(),e=>r(e)),e=>r(e))}))},function(e,t,r){var o=r(0);t.create=(e=>new Promise((t,r)=>{o.Boardmodel.create({type:e.type,name:e.name}).then(e=>t(e),e=>r(e))})),t.list=(()=>new Promise((e,t)=>{o.Boardmodel.findAll({attributes:["id","type","name"]}).then(t=>e(t),e=>t(e))})),t.update=((e,t)=>new Promise((r,s)=>{o.Boardmodel.findById(e).then(e=>{e?e.update({type:t.type,name:t.name}).then(()=>r(),e=>s(e)):s(new Error("board model not found"))},e=>s(e))})),t.remove=(e=>new Promise((t,r)=>{o.Boardmodel.findById(e).then(e=>{e?e.destroy().then(()=>t(),e=>r(e)):r(new Error("board model not found"))},e=>r(e))})),t.setSensors=((e,t)=>new Promise((r,s)=>{o.Boardmodel.findById(e).then(e=>{e?e.addSensors(t).then(()=>r(),e=>s(e)):s(new Error("board model not found"))},e=>s(e))})),t.getSensors=(e=>new Promise((t,r)=>{o.Boardmodel.findById(e).then(e=>{e?e.getSensors({attributes:{exclude:["created_at","updated_at"]}}).then(e=>{e.forEach(e=>delete e.dataValues.BoardSensor),t(e)},e=>r(e)):r(new Error("board model not found"))},e=>r(e))})),t.removeSensor=((e,t)=>new Promise((r,s)=>{o.Boardmodel.findById(e).then(e=>{e?e.removeSensors(t).then(()=>r(),e=>s(e)):s(new Error("board model not found"))},e=>s(e))}))},function(e,t,r){var o=r(1).v1_0_0;t.create=((e,t)=>{"User"===e.client.constructor.name&&e.client.admin?o.boardmodel.create(e.body).then(e=>t.status(200).json({id:e.id}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})}),t.list=((e,t)=>{"User"===e.client.constructor.name&&e.client.admin?o.boardmodel.list().then(e=>t.status(200).json({models:e}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})}),t.update=((e,t)=>{"User"===e.client.constructor.name&&e.client.admin?o.boardmodel.update(e.params.id,e.body).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})}),t.delete=((e,t)=>{"User"===e.client.constructor.name&&e.client.admin?o.boardmodel.remove(e.params.id).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})}),t.setSensors=((e,t)=>{"User"===e.client.constructor.name&&e.client.admin?o.boardmodel.setSensors(e.params.id,e.body.sensors).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})}),t.getSensors=((e,t)=>{"User"===e.client.constructor.name&&e.client.admin?o.boardmodel.getSensors(e.params.id).then(e=>t.status(200).json({sensors:e}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})}),t.removeSensor=((e,t)=>{"User"===e.client.constructor.name&&e.client.admin?o.boardmodel.removeSensor(e.params.id,e.body.sensor_id).then(()=>t.status(200).json({result:!0}),e=>t.status(500).json({error:e.message})):t.status(500).json({error:"Unauthorized"})})},function(e,t,r){e.exports.v1_0_0={board_model:r(19),board:r(11),manage:r(10),record:r(9),sensor:r(8),user:r(7),vitabox:r(6)}},function(e,t,r){e.exports=(e=>{var t=r(20),o=r(5)();e.get("/",o({"1.0.0":(e,t)=>t.json({message:"Welcome to our api!"}),"2.0.0":(e,t)=>t.json({error:"invalid version"})})).post("/register",o({"1.0.0":t.v1_0_0.user.register})).post("/login",o({"1.0.0":t.v1_0_0.user.login})).post("/chpass",o({"1.0.0":t.v1_0_0.user.changePassword})).post("/vitabox",o({"1.0.0":t.v1_0_0.vitabox.create})).get("/vitabox",o({"1.0.0":t.v1_0_0.vitabox.list})).get("/vitabox/:id",o({"1.0.0":t.v1_0_0.vitabox.find})).put("/vitabox/:id",o({"1.0.0":t.v1_0_0.vitabox.update})).delete("/vitabox/:id",o({"1.0.0":t.v1_0_0.vitabox.delete})).post("/vitabox/:id/register",o({"1.0.0":t.v1_0_0.vitabox.register})).post("/vitabox/:id/connect",o({"1.0.0":t.v1_0_0.vitabox.connect})).get("/vitabox/:id/user",o({"1.0.0":t.v1_0_0.vitabox.getUsers})).post("/vitabox/:id/user",o({"1.0.0":t.v1_0_0.vitabox.addUser})).delete("/vitabox/:id/user",o({"1.0.0":t.v1_0_0.vitabox.removeUser})).post("/vitabox/:id/patient",o({"1.0.0":t.v1_0_0.vitabox.addPatient})).get("/vitabox/:id/patient",o({"1.0.0":t.v1_0_0.vitabox.getPatients})).delete("/vitabox/:id/patient",o({"1.0.0":t.v1_0_0.vitabox.removePatient})).post("/vitabox/:id/board",o({"1.0.0":t.v1_0_0.vitabox.addBoard})).get("/vitabox/:id/board",o({"1.0.0":t.v1_0_0.vitabox.getBoards})).delete("/vitabox/:id/board",o({"1.0.0":t.v1_0_0.vitabox.removeBoard})).post("/boardmodel",o({"1.0.0":t.v1_0_0.board_model.create})).get("/boardmodel",o({"1.0.0":t.v1_0_0.board_model.list})).put("/boardmodel/:id",o({"1.0.0":t.v1_0_0.board_model.update})).delete("/boardmodel/:id",o({"1.0.0":t.v1_0_0.board_model.delete})).post("/boardmodel/:id/sensor",o({"1.0.0":t.v1_0_0.board_model.setSensors})).get("/boardmodel/:id/sensor",o({"1.0.0":t.v1_0_0.board_model.getSensors})).delete("/boardmodel/:id/sensor",o({"1.0.0":t.v1_0_0.board_model.removeSensor})).post("/sensor",o({"1.0.0":t.v1_0_0.sensor.create})).get("/sensor",o({"1.0.0":t.v1_0_0.sensor.list})).put("/sensor/:id",o({"1.0.0":t.v1_0_0.sensor.update})).delete("/sensor/:id",o({"1.0.0":t.v1_0_0.sensor.delete})).post("/record",o({"1.0.0":t.v1_0_0.record.create})).get("/record",o({"1.0.0":t.v1_0_0.record.list})).get("/destroy",o({"1.0.0":t.v1_0_0.manage.destroyAll})),e.all("*",(e,t)=>{t.status(404).json({message:"Route could not be found"})})})},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("os")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("crypto")},function(e,t,r){var o=r(2);e.exports.seed=(e=>new Promise((t,r)=>{e.User.count({where:{admin:!0}}).then(s=>{s<1?o.encrypt(["admin@a.aa","user1@a.aa","user2@a.aa","123qweASD","passvita"]).then(o=>{e.User.bulkCreate([{email:o[0],admin:!0,password:o[3]},{email:o[1],password:o[3]},{email:o[2],password:o[3]}]).then(s=>e.Vitabox.create({latitude:"39.6003075",longitude:"-8.3906627",address:"Av. Dr. Aurélio Ribeiro 3, Tomar, Portugal",registered:!0,active:!0,password:o[4]}).then(o=>o.addUsers([s[1].id,s[2].id]).then(()=>e.Boardmodel.bulkCreate([{name:"Zolertia RE-Mote",type:"environmental"},{name:"Xiaomi MI Band",type:"wearable"},{name:"MySignals",type:"non-wearable"}]).then(s=>e.Board.bulkCreate([{vitabox_id:o.id,boardmodel_id:s[0].id,location:"kitchen"},{vitabox_id:o.id,boardmodel_id:s[1].id},{vitabox_id:o.id,boardmodel_id:s[2].id,location:"bedroom"}]).then(()=>e.Sensor.bulkCreate([{transducer:"dht22",measure:"temperature",min_acceptable:"10",max_acceptable:"25",min_possible:"-20",max_possible:"50"},{transducer:"dht22",measure:"humidity",min_acceptable:"30",max_acceptable:"50",min_possible:"20",max_possible:"60"},{transducer:"mq-7",measure:"carbon_monoxide",min_acceptable:"2",max_acceptable:"10",min_possible:"10",max_possible:"500"}]).then(e=>s[0].addSensors([e[0].id,e[1].id]).then(()=>t(),e=>r(e)),e=>r(e)),e=>r(e)),e=>r(e)),e=>r(e)),e=>r(e)),e=>r(e))},e=>r(e)):t()},e=>r(e))}))},function(e,t,r){var o=r(3),s=new o.Schema({value:{type:Number,required:!0},datetime:{type:Date,default:Date.now()},patient_id:{type:String,required:!1},board_id:{type:String,required:!0},sensor_id:{type:String,required:!0}});e.exports=o.model("Record",s)},function(e,t,r){"use strict";e.exports=((e,t)=>{var r=e.define("Vitabox",{id:{type:t.UUID,defaultValue:t.UUIDV4,primaryKey:!0},password:{type:t.STRING,allowNull:!1},latitude:{type:t.DECIMAL(10,7),allowNull:!0,defaultValue:null,validate:{min:{args:-90,msg:"latitude minimum acceptable value is -90"},max:{args:90,msg:"latitude maximum acceptable value is 90"}}},longitude:{type:t.DECIMAL(10,7),allowNull:!0,defaultValue:null,validate:{min:{args:-180,msg:"longitude minimum acceptable value is -180"},max:{args:180,msg:"longitude maximum acceptable value is 180"}}},settings:{type:t.JSON,allowNull:!0,defaultValue:null},address:{type:t.STRING},registered:{type:t.BOOLEAN,defaultValue:!1},active:{type:t.BOOLEAN,defaultValue:!1}},{underscored:!0});return r.associate=function(e){e.Vitabox.belongsToMany(e.User,{through:e.UserVitabox}),e.Vitabox.hasMany(e.Patient),e.Vitabox.hasMany(e.Board)},r})},function(e,t,r){"use strict";e.exports=((e,t)=>{var r=e.define("User",{id:{type:t.UUID,defaultValue:t.UUIDV4,primaryKey:!0},email:{type:t.STRING,allowNull:!1,unique:{args:!0,msg:"email already registered"}},password:{type:t.STRING,allowNull:!1},admin:{type:t.BOOLEAN,defaultValue:!1}},{scopes:{profile:{attributes:{exclude:["password"]}}},underscored:!0});return r.associate=function(e){e.User.belongsToMany(e.Vitabox,{through:e.UserVitabox})},r})},function(e,t,r){"use strict";e.exports=((e,t)=>{return e.define("UserVitabox",{sponsor:{type:t.BOOLEAN,defaultValue:!1}},{underscored:!0})})},function(e,t,r){"use strict";e.exports=((e,t)=>{var r=e.define("Sensor",{id:{type:t.UUID,defaultValue:t.UUIDV4,primaryKey:!0},transducer:{type:t.STRING,allowNull:{args:!1,msg:"transducer name must be defined"}},measure:{type:t.STRING,allowNull:{args:!1,msg:"transducer measure must be defined"}},min_acceptable:{type:t.DECIMAL(10,5),allowNull:{args:!1,msg:"minimum acceptable value must be defined"}},max_acceptable:{type:t.DECIMAL(10,5),allowNull:{args:!1,msg:"maximum acceptable value must be defined"}},min_possible:{type:t.DECIMAL(10,5),allowNull:{args:!1,msg:"minimum possible value must be defined"}},max_possible:{type:t.DECIMAL(10,5),allowNull:{args:!1,msg:"maximum possible value must be defined"}}},{underscored:!0});return r.associate=function(e){e.Sensor.belongsToMany(e.Boardmodel,{through:"BoardSensor"})},r})},function(e,t,r){"use strict";e.exports=((e,t)=>{var r=e.define("Patient",{id:{type:t.UUID,defaultValue:t.UUIDV4,primaryKey:!0},birthdate:{type:t.DATEONLY,allowNull:{args:!1,msg:"patient birth date must be defined"}},name:{type:t.STRING,allowNull:{args:!1,msg:"patient name must be defined"}},gender:{type:t.ENUM,values:["undefined","male","female"],defaultValue:"undefined",validate:{isIn:{args:["male","female","undefined"],msg:"gender must be 'male', 'female' or 'undefined'"}}}},{underscored:!0});return r.associate=function(e){e.Patient.belongsTo(e.Vitabox)},r})},function(e,t,r){"use strict";e.exports=((e,t)=>{var r=e.define("Board",{id:{type:t.UUID,defaultValue:t.UUIDV4,primaryKey:!0},location:{type:t.STRING,allowNull:!0,defaultValue:null}},{underscored:!0});return r.associate=function(e){e.Board.belongsTo(e.Vitabox),e.Board.belongsTo(e.Boardmodel)},r})},function(e,t,r){"use strict";e.exports=((e,t)=>{var r=e.define("Boardmodel",{id:{type:t.UUID,defaultValue:t.UUIDV4,primaryKey:!0},type:{type:t.ENUM,values:["environmental","wearable","non-wearable"],allowNull:{args:!1,msg:"board type must be defined"},validate:{isIn:{args:["environmental","wearable","non-wearable"],msg:"board type must be 'environmental', 'wearable' or 'non-wearable'"}}},name:{type:t.STRING,allowNull:!1,unique:{args:!0,msg:"board model already registered"}}},{underscored:!0});return r.associate=function(e){e.Boardmodel.hasMany(e.Board),e.Boardmodel.belongsToMany(e.Sensor,{through:"BoardSensor"})},r})},function(e,t){e.exports=require("sequelize")},function(e,t){e.exports=require("dotenv")},function(e,t){e.exports=require("cluster")},function(e,t,r){(function(e){var t=r(38);if(r(37).config(),t.isMaster){var o=r(0);o.sequelize.sync().then(()=>{r(27).seed(o).then(()=>{console.log("[32m%s[0m.","(PLAIN) Connection established with MongoDB and MySQL");var e=r(23).cpus().length;console.log("Master cluster setting up "+e+" workers...");for(var o=0;o<e;o++)t.fork();t.on("exit",function(e,r,o){console.log("Worker "+e.process.pid+" died with code: "+r+", and signal: "+o+"-> Starting a new worker"),t.fork()})},e=>{console.log("Unable to seed Databases."),console.log(e.message),process.exit(1)})},e=>{console.log("Unable to connect to Databases."),console.log(e),process.exit(1)})}else{var s=r(22),n=r(21),a=r(4),i=r(1).v1_0_0.utils,d=s();d.use(a.urlencoded({extended:!0})),d.use(a.json()),d.use((e,t,r)=>{t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept, Authorization"),t.header("Access-Control-Allow-Methods","POST, GET, PUT, DELETE, OPTIONS"),t.header("Access-Control-Allow-Credentials",!0),e.headers&&e.headers.authorization?i.validateToken(e.headers.authorization,e.connection.remoteAddress).then(o=>{o?(e.client=o,r()):t.status(500).json({msg:"Client not registered"})},e=>t.status(500).json({msg:e.message})):(e.user=void 0,r())}),d.use(s.static(e+"/public")),n(d);var u=process.env.PORT||8080;d.listen(u,()=>{console.log("[32m%s %d[0m.","(PLAIN) Server http listening on port",u)})}}).call(this,"")}]);
//# sourceMappingURL=bundle.js.map